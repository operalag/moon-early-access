---
phase: 02-campaign-tracking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/campaign/route.ts
autonomous: true

must_haves:
  truths:
    - "Campaign attributions can be stored in database"
    - "API accepts campaign attribution requests"
    - "Duplicate attributions are prevented (idempotency)"
  artifacts:
    - path: "src/app/api/campaign/route.ts"
      provides: "Campaign attribution POST endpoint"
      exports: ["POST"]
  key_links:
    - from: "src/app/api/campaign/route.ts"
      to: "supabaseAdmin"
      via: "database insert"
      pattern: "supabaseAdmin.*from.*campaign_attributions"
---

<objective>
Create the campaign attribution API endpoint and database table.

Purpose: Establish the foundation for tracking which marketing campaigns bring users to the app. The table stores user_id + campaign_id + timestamp, and the API handles attribution requests with idempotency.

Output: Working POST /api/campaign endpoint that stores campaign attributions in Supabase.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/app/api/referral/route.ts
@src/lib/supabaseAdmin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create campaign_attributions table in Supabase</name>
  <files>N/A (Supabase dashboard or migration)</files>
  <action>
Create the campaign_attributions table in Supabase using the SQL editor or supabase CLI. Table schema:

```sql
CREATE TABLE campaign_attributions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id BIGINT NOT NULL,
  campaign_id TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id)  -- One attribution per user (first touch)
);

-- Index for campaign queries
CREATE INDEX idx_campaign_attributions_campaign_id ON campaign_attributions(campaign_id);

-- RLS: Disable for now (admin-only access via service role)
ALTER TABLE campaign_attributions ENABLE ROW LEVEL SECURITY;
```

Note: The UNIQUE(user_id) constraint ensures idempotency - a user can only be attributed to one campaign (first touch attribution model).
  </action>
  <verify>
Run in Supabase SQL editor:
```sql
SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'campaign_attributions';
```
Should return: id (uuid), user_id (bigint), campaign_id (text), created_at (timestamp with time zone)
  </verify>
  <done>Table exists with correct schema and unique constraint on user_id</done>
</task>

<task type="auto">
  <name>Task 2: Create POST /api/campaign endpoint</name>
  <files>src/app/api/campaign/route.ts</files>
  <action>
Create the campaign attribution API endpoint following the pattern from /api/referral/route.ts.

The endpoint should:
1. Accept POST with { campaignId: string, userId: number }
2. Validate both parameters exist and campaignId is non-empty string
3. Check idempotency: if user already has attribution, return 200 with { message: 'Already attributed' }
4. Insert into campaign_attributions table using supabaseAdmin (bypasses RLS)
5. Return { success: true } on successful insert

Error handling:
- Missing parameters: 400
- Insert error (other than duplicate): 500
- Duplicate key violation: treat as success (idempotent)

Do NOT award points for campaign attribution (unlike referrals). This is pure tracking.
  </action>
  <verify>
Test with curl:
```bash
# First call should succeed
curl -X POST http://localhost:3000/api/campaign \
  -H "Content-Type: application/json" \
  -d '{"campaignId":"V1a","userId":123456789}'

# Second call should return "Already attributed"
curl -X POST http://localhost:3000/api/campaign \
  -H "Content-Type: application/json" \
  -d '{"campaignId":"V1b","userId":123456789}'
```
  </verify>
  <done>POST /api/campaign returns 200 on valid request, handles duplicates gracefully, stores attribution in database</done>
</task>

</tasks>

<verification>
1. Table exists: `SELECT * FROM campaign_attributions LIMIT 1;` runs without error
2. API responds: `curl -X POST localhost:3000/api/campaign -H "Content-Type: application/json" -d '{"campaignId":"test","userId":1}'` returns 200
3. Idempotency works: Second POST with same userId returns { message: 'Already attributed' }
4. Data persists: `SELECT * FROM campaign_attributions WHERE user_id = 1;` shows the record
</verification>

<success_criteria>
- campaign_attributions table exists in Supabase with correct schema
- POST /api/campaign endpoint accepts {campaignId, userId} and stores attribution
- Duplicate user attributions are handled gracefully (first touch wins)
- API uses supabaseAdmin for RLS bypass
</success_criteria>

<output>
After completion, create `.planning/phases/02-campaign-tracking/02-01-SUMMARY.md`
</output>
