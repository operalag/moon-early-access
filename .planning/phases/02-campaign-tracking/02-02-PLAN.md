---
phase: 02-campaign-tracking
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/components/AuthWrapper.tsx
  - src/app/api/debug/campaigns/route.ts
autonomous: true

must_haves:
  truths:
    - "Numeric startapp params are routed to referral flow"
    - "Non-numeric startapp params (containing letters) are routed to campaign flow"
    - "Existing referral flow remains unchanged"
    - "Campaign attributions are queryable via debug endpoint"
  artifacts:
    - path: "src/components/AuthWrapper.tsx"
      provides: "Detection and routing logic for startapp parameter"
      contains: "handleCampaign"
    - path: "src/app/api/debug/campaigns/route.ts"
      provides: "Debug endpoint for viewing campaign data"
      exports: ["GET"]
  key_links:
    - from: "src/components/AuthWrapper.tsx"
      to: "/api/campaign"
      via: "fetch POST"
      pattern: "fetch.*api/campaign"
    - from: "src/components/AuthWrapper.tsx"
      to: "/api/referral"
      via: "fetch POST (unchanged)"
      pattern: "fetch.*api/referral"
    - from: "src/app/api/debug/campaigns/route.ts"
      to: "campaign_attributions"
      via: "supabaseAdmin query"
      pattern: "supabaseAdmin.*from.*campaign_attributions"
---

<objective>
Wire up the AuthWrapper to detect and route startapp parameters, and create a debug endpoint for campaign data.

Purpose: Complete the campaign tracking feature by adding detection logic that distinguishes between referral codes (numeric user IDs) and campaign codes (alphanumeric like "V1a"), then routes each to the appropriate handler.

Output: AuthWrapper correctly routes startapp params; debug endpoint shows campaign attribution data.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-campaign-tracking/02-01-SUMMARY.md
@src/components/AuthWrapper.tsx
@src/app/api/debug/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add campaign detection and routing to AuthWrapper</name>
  <files>src/components/AuthWrapper.tsx</files>
  <action>
Modify AuthWrapper.tsx to detect whether startapp parameter is a referral (numeric) or campaign (contains letters).

Detection logic:
```typescript
function isReferralCode(code: string): boolean {
  // Referral codes are purely numeric Telegram user IDs (e.g., "458184707")
  return /^\d+$/.test(code);
}
```

Routing logic (inside the interval callback, after getting startParam):
1. If startParam equals user's own ID -> ignore (self-referral check, already exists)
2. If isReferralCode(startParam) -> call handleReferral (existing flow, unchanged)
3. Else -> call new handleCampaign function

Add handleCampaign function (similar pattern to handleReferral):
```typescript
async function handleCampaign(campaignId: string, userId: number) {
  try {
    // Silent attribution - no UI feedback needed for campaigns
    const res = await fetch('/api/campaign', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ campaignId, userId }),
    });

    if (!res.ok) {
      const data = await res.json();
      console.error("Campaign Attribution Error:", data.error);
    }
    // No success UI - campaign tracking is silent
  } catch (err) {
    console.error("Campaign Attribution Failed:", err);
  }
}
```

Update the session storage key to be type-specific:
- For referrals: keep 'referral_processed'
- For campaigns: use 'campaign_processed'

This ensures a user can be both referred AND attributed to a campaign if they somehow have both params (edge case).

Important: Do NOT modify the referral flow logic. Only add the detection branching and the new campaign handler.
  </action>
  <verify>
1. Dev server running: `npm run dev`
2. Test referral detection: Visit app with `?startapp=458184707` - should trigger referral flow
3. Test campaign detection: Visit app with `?startapp=V1a` - should call /api/campaign (check Network tab)
4. Console shows no errors for either flow
  </verify>
  <done>AuthWrapper correctly identifies referral vs campaign codes and routes to appropriate handlers</done>
</task>

<task type="auto">
  <name>Task 2: Create debug endpoint for campaign data</name>
  <files>src/app/api/debug/campaigns/route.ts</files>
  <action>
Create a debug API endpoint to query campaign attribution data. Follow the pattern from /api/debug/route.ts.

The endpoint should support:
1. GET without params: Return aggregated stats (count per campaign)
2. GET with ?campaignId=X: Return all users attributed to that campaign
3. GET with ?userId=X: Return the campaign attribution for that user (if any)

Response format:
```typescript
// No params - aggregated stats
{
  total_attributions: number,
  by_campaign: { [campaignId: string]: number }
}

// With campaignId
{
  campaign_id: string,
  users: Array<{ user_id: number, created_at: string }>
}

// With userId
{
  user_id: number,
  campaign_id: string | null,
  created_at: string | null
}
```

Use supabaseAdmin for queries (no RLS restrictions).
  </action>
  <verify>
Test with curl:
```bash
# Get all stats
curl http://localhost:3000/api/debug/campaigns

# Get users for campaign V1a
curl "http://localhost:3000/api/debug/campaigns?campaignId=V1a"

# Get attribution for specific user
curl "http://localhost:3000/api/debug/campaigns?userId=123456789"
```
  </verify>
  <done>Debug endpoint returns campaign attribution data in requested format</done>
</task>

</tasks>

<verification>
1. Detection logic works:
   - `?startapp=458184707` (numeric) -> referral flow triggered
   - `?startapp=V1a` (alphanumeric) -> campaign flow triggered
2. Existing referral flow unchanged: Points still awarded to referrer
3. Campaign attribution recorded: Check via debug endpoint
4. Debug endpoint works: All three query modes return expected data
</verification>

<success_criteria>
- Numeric startapp params route to existing referral flow (unchanged behavior)
- Alphanumeric startapp params route to new campaign attribution flow
- Campaign attributions stored silently (no user-facing UI)
- Debug endpoint queryable for campaign stats and user lookups
- No regressions in referral functionality
</success_criteria>

<output>
After completion, create `.planning/phases/02-campaign-tracking/02-02-SUMMARY.md`
</output>
