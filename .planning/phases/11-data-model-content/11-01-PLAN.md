---
phase: 11-data-model-content
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/YYYYMMDDHHMMSS_user_education_progress.sql
  - src/lib/educationTypes.ts
  - src/data/education_modules.json
autonomous: true

must_haves:
  truths:
    - "Database can store one progress record per user per module"
    - "TypeScript provides type safety for all 5 slide variants"
    - "Module 1 contains exactly 6 slides matching user spec"
    - "Module 2 and 3 exist as locked placeholders"
  artifacts:
    - path: "supabase/migrations/*_user_education_progress.sql"
      provides: "user_education_progress table with RLS"
      contains: "CREATE TABLE public.user_education_progress"
    - path: "src/lib/educationTypes.ts"
      provides: "Slide discriminated union and Module type"
      exports: ["Slide", "Module", "EducationModulesData", "UserEducationProgress"]
    - path: "src/data/education_modules.json"
      provides: "Module 1 content with 6 slides, Module 2/3 placeholders"
      min_lines: 80
  key_links:
    - from: "src/data/education_modules.json"
      to: "src/lib/educationTypes.ts"
      via: "JSON structure matches TypeScript types"
      pattern: "type.*Slide.*=.*intro.*concept.*quiz.*action.*reward"
    - from: "src/lib/educationTypes.ts"
      to: "supabase/migrations/*_user_education_progress.sql"
      via: "UserEducationProgress type matches table columns"
      pattern: "user_id.*module_id.*slide_index.*completed_at.*badge_earned"
---

<objective>
Create the data foundation for education modules: database schema for progress tracking, TypeScript types for slide variants, and static JSON content for Module 1.

Purpose: Phases 12-14 depend on these types and structures being in place. This is pure data layer work with no UI.
Output: Migration file, TypeScript types, JSON content file
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-data-model-content/11-RESEARCH.md

# Existing patterns to follow
@src/lib/pointsEngine.ts
@supabase/migrations/20260127173157_campaign_attributions.sql
@tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user_education_progress database migration</name>
  <files>supabase/migrations/YYYYMMDDHHMMSS_user_education_progress.sql</files>
  <action>
Create a Supabase migration using `npx supabase migration new user_education_progress`.

The migration should create a table with these columns:
- `id` UUID PRIMARY KEY DEFAULT gen_random_uuid()
- `user_id` BIGINT NOT NULL (Telegram ID, matches pointsEngine pattern)
- `module_id` TEXT NOT NULL (e.g., "module-1")
- `slide_index` INTEGER NOT NULL DEFAULT 0 (current slide position)
- `completed_at` TIMESTAMPTZ (null until module completed)
- `badge_earned` BOOLEAN DEFAULT FALSE
- `created_at` TIMESTAMPTZ DEFAULT NOW()
- `updated_at` TIMESTAMPTZ DEFAULT NOW()

Add constraints and indexes:
- UNIQUE constraint on (user_id, module_id) - one progress record per user per module
- Index on user_id (most common query pattern)
- Index on completed_at WHERE completed_at IS NOT NULL (completion queries)

Enable RLS with NO public policies (service-role only, same pattern as campaign_attributions).

Follow the exact comment style from campaign_attributions.sql.
  </action>
  <verify>
Migration file exists in supabase/migrations/ with correct table structure.
Run: `cat supabase/migrations/*_user_education_progress.sql | grep -E "(CREATE TABLE|CONSTRAINT|INDEX|RLS)" | head -10`
  </verify>
  <done>
Migration file created with user_education_progress table, composite unique constraint on (user_id, module_id), indexes for user_id and completed_at, and RLS enabled with no public policies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Define TypeScript types for education modules</name>
  <files>src/lib/educationTypes.ts</files>
  <action>
Create TypeScript type definitions using discriminated unions for slide variants.

Define 5 slide types with `type` as discriminator:
1. `IntroSlide` - type: 'intro', body, optional mascotImage
2. `ConceptSlide` - type: 'concept', body, optional diagram
3. `QuizSlide` - type: 'quiz', question, options array [{id, text}], correctOptionId, explanation
4. `ActionSlide` - type: 'action', instruction, actionType ('wallet_connect' | 'channel_join'), buttonText
5. `RewardSlide` - type: 'reward', body, pointsAwarded, badgeId, badgeName

All slides share base fields: id (string), title (string).

Define Module type:
- id, title, description, icon (emoji string)
- totalPoints, badgeId, badgeName
- isLocked (boolean), prerequisiteModuleId (string | null)
- slides: Slide[]

Define wrapper types:
- `EducationModulesData` = { version: string, modules: Module[] }
- `UserEducationProgress` = database row type matching migration columns

Export all types. Use JSDoc comments for complex fields.
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit src/lib/educationTypes.ts`
Types export correctly: `grep "export type" src/lib/educationTypes.ts | wc -l` should be >= 8
  </verify>
  <done>
educationTypes.ts exports Slide (union of 5 variants), Module, EducationModulesData, and UserEducationProgress types. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Module 1 content and placeholder modules</name>
  <files>src/data/education_modules.json</files>
  <action>
Create education_modules.json with Module 1 "The Kit Bag" content and Module 2/3 placeholders.

Structure:
```json
{
  "version": "1.0.0",
  "modules": [...]
}
```

**Module 1: "The Kit Bag" (id: "module-1")**
- title: "The Kit Bag"
- description: "Gear up with your TON wallet"
- icon: "ðŸŽ’"
- totalPoints: 700
- badgeId: "kit-owner"
- badgeName: "Kit Owner"
- isLocked: false
- prerequisiteModuleId: null

6 slides per user spec:
1. Intro (slide-1-1): "Hey Future Analyst! Before you step onto the pitch to trade predictions, you need your gear."
2. Concept (slide-1-2): "Why do I need it? Unlike a bank that holds your money, a Wallet lets YOU hold your money."
3. Quiz (slide-1-3): "Who controls your crypto wallet?" Options: A) App Developer, B) Me (correct), C) Bank Manager
4. Concept (slide-1-4): "We use TON wallets here. Think of your TON Wallet address like your Jersey Number."
5. Action (slide-1-5): "Let's Suit Up! Connect your TON wallet now to finish this Over." actionType: "wallet_connect"
6. Reward (slide-1-6): "OVER COMPLETE!" with 700 points and Kit Owner badge

**Module 2: "The Ticket & The Score" (id: "module-2")**
- title: "The Ticket & The Score"
- description: "Learn about TON vs USDT"
- icon: "ðŸŽ«"
- totalPoints: 700
- badgeId: "ticket-holder"
- badgeName: "Ticket Holder"
- isLocked: true
- prerequisiteModuleId: "module-1"
- slides: [] (empty - placeholder)

**Module 3: "The Analyst vs. The Gambler" (id: "module-3")**
- title: "The Analyst vs. The Gambler"
- description: "Trading vs Betting mindset"
- icon: "ðŸŽ¯"
- totalPoints: 600
- badgeId: "analyst"
- badgeName: "Analyst"
- isLocked: true
- prerequisiteModuleId: "module-2"
- slides: [] (empty - placeholder)

Use descriptive slide IDs like "slide-1-1" (module 1, slide 1).
Ensure JSON is valid and properly formatted.
  </action>
  <verify>
JSON is valid: `node -e "require('./src/data/education_modules.json')"`
Module 1 has 6 slides: `node -e "const d = require('./src/data/education_modules.json'); console.log(d.modules[0].slides.length);"` should output 6
TypeScript import works: Create a temp test file that imports the JSON and types, verify no errors
  </verify>
  <done>
education_modules.json contains Module 1 with 6 slides (intro, concept, quiz, concept, action, reward), Module 2 and 3 as locked placeholders with empty slides arrays. Total points: 700 + 700 + 600 = 2000 across all modules.
  </done>
</task>

</tasks>

<verification>
All three artifacts exist and are consistent:

1. **Migration exists and is well-formed:**
   ```bash
   ls supabase/migrations/*_user_education_progress.sql
   ```

2. **Types compile and export correctly:**
   ```bash
   npx tsc --noEmit
   grep "export type" src/lib/educationTypes.ts
   ```

3. **JSON is valid and complete:**
   ```bash
   node -e "
     const data = require('./src/data/education_modules.json');
     const types = require('./src/lib/educationTypes');
     console.log('Version:', data.version);
     console.log('Modules:', data.modules.length);
     console.log('Module 1 slides:', data.modules[0].slides.length);
     console.log('Module 2 locked:', data.modules[1].isLocked);
     console.log('Module 3 locked:', data.modules[2].isLocked);
   "
   ```

4. **Types match JSON structure (compile test):**
   ```bash
   # Verify import works in a Next.js context
   npx tsc --noEmit
   ```
</verification>

<success_criteria>
1. Database migration file exists with correct table structure, constraints, indexes, and RLS
2. TypeScript types file exports all required types (Slide variants, Module, EducationModulesData, UserEducationProgress)
3. JSON file contains Module 1 with exactly 6 slides matching user spec content
4. JSON file contains Module 2 and 3 as locked placeholders with empty slides arrays
5. Project compiles without TypeScript errors: `npx tsc --noEmit` passes
</success_criteria>

<output>
After completion, create `.planning/phases/11-data-model-content/11-01-SUMMARY.md`
</output>
