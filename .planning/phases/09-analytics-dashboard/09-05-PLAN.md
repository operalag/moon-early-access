---
phase: 09-analytics-dashboard
plan: 05
type: execute
wave: 4
depends_on: ["09-04"]
files_modified:
  - src/components/admin/ExportButton.tsx
  - src/components/admin/DateRangePicker.tsx
  - src/components/admin/DashboardHeader.tsx
  - src/app/admin/dashboard/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can export dashboard data to CSV"
    - "User can select date range for charts"
    - "Dashboard is mobile-responsive and usable on phone"
    - "All charts and tables display correctly on mobile"
  artifacts:
    - path: "src/components/admin/ExportButton.tsx"
      provides: "CSV export functionality"
      exports: ["ExportButton"]
    - path: "src/components/admin/DateRangePicker.tsx"
      provides: "Date range selection for filtering"
      exports: ["DateRangePicker"]
    - path: "src/components/admin/DashboardHeader.tsx"
      provides: "Dashboard header with controls"
      exports: ["DashboardHeader"]
  key_links:
    - from: "src/components/admin/ExportButton.tsx"
      to: "react-csv"
      via: "CSVLink component import"
      pattern: "from.*react-csv"
    - from: "src/app/admin/dashboard/page.tsx"
      to: "src/components/admin/DateRangePicker.tsx"
      via: "date range state management"
      pattern: "DateRangePicker"
---

<objective>
Add export capabilities and polish: CSV export for all data sections, date range picker for filtering, and mobile-responsive refinements.

Purpose: Enable reporting workflows and ensure dashboard is usable anywhere.
Output: Complete, polished admin dashboard with export and filtering capabilities.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-analytics-dashboard/09-RESEARCH.md
@.planning/phases/09-analytics-dashboard/09-01-SUMMARY.md
@.planning/phases/09-analytics-dashboard/09-02-SUMMARY.md
@.planning/phases/09-analytics-dashboard/09-03-SUMMARY.md
@.planning/phases/09-analytics-dashboard/09-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create export and date range components</name>
  <files>
    - src/components/admin/ExportButton.tsx
    - src/components/admin/DateRangePicker.tsx
    - src/components/admin/DashboardHeader.tsx
  </files>
  <action>
1. Create `src/components/admin/ExportButton.tsx`:
   - 'use client' directive
   - Import { CSVLink } from 'react-csv'
   - Props: data: any[], filename: string, headers?: { label: string, key: string }[]
   - Generate filename with date: `${filename}-${format(new Date(), 'yyyy-MM-dd')}.csv`
   - Styling: bg-zinc-800 hover:bg-zinc-700 text-white text-xs px-3 py-2 rounded-lg
   - Icon: Download icon from lucide-react
   - Handle empty data: disable button, show tooltip

2. Create `src/components/admin/DateRangePicker.tsx`:
   - 'use client' directive
   - Props:
     - value: { from: Date, to: Date }
     - onChange: (range: { from: Date, to: Date }) => void
   - Preset buttons: "Last 7 days", "Last 30 days", "Last 90 days", "All time"
   - Use date-fns: subDays, startOfDay, endOfDay
   - Styling:
     - Button group: flex gap-2
     - Active: bg-yellow-500 text-black
     - Inactive: bg-zinc-800 text-white hover:bg-zinc-700
   - Compact design for mobile (text-xs)

3. Create `src/components/admin/DashboardHeader.tsx`:
   - 'use client' directive
   - Props:
     - title: string
     - lastUpdated: Date | null
     - onRefresh: () => void
     - dateRange: { from: Date, to: Date }
     - onDateRangeChange: (range) => void
   - Layout:
     - Title (h1, text-2xl font-bold)
     - Last updated timestamp (text-xs text-zinc-500)
     - Refresh button (icon, rotates while loading)
     - DateRangePicker
   - Responsive: stack on mobile, row on lg
  </action>
  <verify>
    - ExportButton triggers CSV download
    - DateRangePicker shows preset buttons
    - DashboardHeader displays title and controls
  </verify>
  <done>
    - ExportButton downloads CSV with formatted filename
    - DateRangePicker provides 4 preset ranges
    - DashboardHeader combines title, refresh, and date picker
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate export and filtering into dashboard</name>
  <files>
    - src/app/admin/dashboard/page.tsx
  </files>
  <action>
1. Add date range state:
   - useState for dateRange: { from: Date, to: Date }
   - Default: last 30 days
   - Pass dateRange to API fetches as query params

2. Update API calls to accept date filtering:
   - Add ?from=&to= query params to user, engagement, points APIs
   - APIs should filter by created_at within range

3. Replace current header with DashboardHeader:
   - Pass lastUpdated from fetch timestamp
   - Connect refresh to refetch function
   - Connect dateRange state

4. Add ExportButton to each section:
   - MetricCards section: export overview data
   - UserGrowth section: export time series
   - Points section: export points breakdown
   - Campaigns section: export campaign table
   - Referrals section: export top referrers

5. Define CSV headers for each export:
   - Overview: [Total Users, Wallets, Points, Referrals]
   - Users: [Date, Daily New, Cumulative]
   - Points: [Reason, Total Distributed, Transactions]
   - Campaigns: [Campaign ID, Users, First Seen, Last Seen]
   - Referrals: [Rank, Name, Referral Count]
  </action>
  <verify>
    - Date range picker changes data in charts
    - Export buttons download CSV files
    - Refresh button updates data
  </verify>
  <done>
    - Dashboard has functional date range filtering
    - All sections have export buttons
    - Refresh updates all data
    - Date range persists across refreshes
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete admin analytics dashboard with:
    - Protected admin route
    - Overview metrics (4 cards)
    - User growth chart
    - Wallet conversion funnel
    - Points economy chart
    - Engagement heatmap
    - Retention curves
    - Feature usage pie chart
    - Campaign performance table
    - Referral network stats
    - Date range filtering
    - CSV export
    - Mobile responsive
  </what-built>
  <how-to-verify>
    1. Open http://localhost:3000/admin/dashboard as admin user (ID: 458184707)
    2. Verify all 6 charts display with real data
    3. Test date range presets (7d, 30d, 90d, all time)
    4. Click export button on any section, verify CSV downloads
    5. Test on mobile viewport (toggle device mode in DevTools)
    6. Verify charts scroll horizontally on mobile
    7. Test as non-admin user (should see Access Denied)
    8. Verify auto-refresh works (watch last updated timestamp)
  </how-to-verify>
  <resume-signal>Type "approved" if dashboard works correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Build passes: `npm run build` completes without errors
2. Date range picker updates all charts
3. Export buttons download valid CSV files
4. Dashboard responsive on mobile (320px width)
5. All charts visible and interactive
6. Non-admin access blocked
7. Auto-refresh works every 60 seconds
</verification>

<success_criteria>
- Export buttons on all data sections
- Date range filtering affects user growth, engagement, points charts
- Dashboard fully usable on mobile devices
- CSV files download with proper formatting
- Visual polish complete (consistent styling, loading states)
- Admin protection verified working
</success_criteria>

<output>
After completion, create `.planning/phases/09-analytics-dashboard/09-05-SUMMARY.md`
</output>
