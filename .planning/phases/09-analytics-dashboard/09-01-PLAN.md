---
phase: 09-analytics-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/adminConfig.ts
  - src/components/admin/AdminGuard.tsx
  - src/app/admin/layout.tsx
  - src/app/admin/page.tsx
  - src/app/api/admin/analytics/overview/route.ts
  - src/components/admin/MetricCard.tsx
autonomous: true

must_haves:
  truths:
    - "Admin user can access /admin route without errors"
    - "Non-admin user sees Access Denied on /admin route"
    - "Overview API returns totalUsers, walletsConnected, totalPoints, totalReferrals"
  artifacts:
    - path: "src/lib/adminConfig.ts"
      provides: "Admin ID allowlist and isAdmin function"
      exports: ["ADMIN_TELEGRAM_IDS", "isAdmin"]
    - path: "src/components/admin/AdminGuard.tsx"
      provides: "Route protection component"
      exports: ["AdminGuard"]
    - path: "src/app/admin/layout.tsx"
      provides: "Admin layout with guard wrapper"
      contains: "AdminGuard"
    - path: "src/app/api/admin/analytics/overview/route.ts"
      provides: "Summary metrics API endpoint"
      exports: ["GET"]
  key_links:
    - from: "src/app/admin/layout.tsx"
      to: "src/components/admin/AdminGuard.tsx"
      via: "import and wrap children"
      pattern: "AdminGuard"
    - from: "src/components/admin/AdminGuard.tsx"
      to: "src/hooks/useTelegram.tsx"
      via: "useTelegram hook for user.id"
      pattern: "useTelegram"
---

<objective>
Set up the admin dashboard foundation: install charting dependencies, create admin route protection, and build the overview metrics API endpoint.

Purpose: Establish the protected admin infrastructure before building visualizations. Without route protection and basic API, charts have nothing to render.
Output: Protected /admin route with MetricCard grid showing key stats.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-analytics-dashboard/09-RESEARCH.md

# Existing patterns
@src/hooks/useTelegram.tsx
@src/lib/supabaseAdmin.ts
@src/app/api/debug/campaigns/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create admin config</name>
  <files>
    - package.json
    - src/lib/adminConfig.ts
  </files>
  <action>
1. Install required charting dependencies:
   ```bash
   npm install recharts date-fns @uiw/react-heat-map react-csv
   npm install -D @types/react-csv
   ```

2. Create `src/lib/adminConfig.ts`:
   - Export `ADMIN_TELEGRAM_IDS` array with user ID 458184707 (primary admin from existing patterns)
   - Export `isAdmin(telegramId: number | undefined): boolean` function
   - Return false if telegramId is undefined/falsy
   - Return true if telegramId is in ADMIN_TELEGRAM_IDS array
  </action>
  <verify>
    - `npm ls recharts date-fns @uiw/react-heat-map react-csv` shows all installed
    - `cat src/lib/adminConfig.ts` shows isAdmin function and ADMIN_TELEGRAM_IDS export
  </verify>
  <done>
    - All four npm packages installed in package.json
    - adminConfig.ts exists with isAdmin function that checks against allowlist
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AdminGuard component and admin layout</name>
  <files>
    - src/components/admin/AdminGuard.tsx
    - src/app/admin/layout.tsx
    - src/app/admin/page.tsx
    - src/components/admin/MetricCard.tsx
  </files>
  <action>
1. Create `src/components/admin/AdminGuard.tsx`:
   - 'use client' directive (must access useTelegram hook)
   - Import useTelegram from '@/hooks/useTelegram'
   - Import isAdmin from '@/lib/adminConfig'
   - Import useRouter from 'next/navigation'
   - Show "Access Denied" centered div (red text on black bg) if user is null or !isAdmin(user.id)
   - Redirect non-admins to '/' via useEffect + router.replace
   - Return children wrapped in fragment if admin

2. Create `src/components/admin/MetricCard.tsx`:
   - 'use client' directive
   - Props: title (string), value (string|number), change? (string), trend? ('up'|'down'|'neutral')
   - Style: bg-zinc-900, border-zinc-800, rounded-xl, p-4
   - Title: text-xs text-zinc-500 uppercase tracking-wider
   - Value: text-2xl font-bold text-white mt-1
   - Trend colors: up=green-500, down=red-500, neutral=zinc-500

3. Create `src/app/admin/layout.tsx`:
   - Import AdminGuard
   - Wrap children in AdminGuard
   - No BottomNav for admin pages (AdminGuard handles full layout)
   - Background: bg-[#050505] min-h-screen

4. Create `src/app/admin/page.tsx`:
   - 'use client' directive
   - Redirect to /admin/dashboard using next/navigation redirect
   - Or show simple "Redirecting to dashboard..." message
  </action>
  <verify>
    - Files exist at all 4 paths
    - AdminGuard imports useTelegram and isAdmin
    - Admin layout wraps children in AdminGuard
  </verify>
  <done>
    - AdminGuard component blocks non-admin access
    - MetricCard component ready for use
    - /admin route protected and redirects to dashboard
  </done>
</task>

<task type="auto">
  <name>Task 3: Create overview API and dashboard page</name>
  <files>
    - src/app/api/admin/analytics/overview/route.ts
    - src/app/admin/dashboard/page.tsx
  </files>
  <action>
1. Create `src/app/api/admin/analytics/overview/route.ts`:
   - Import supabaseAdmin from '@/lib/supabaseAdmin'
   - GET handler that returns:
     - totalUsers: COUNT from profiles table
     - walletsConnected: COUNT from profiles WHERE is_wallet_connected = true
     - walletConversionRate: (walletsConnected / totalUsers * 100).toFixed(1)
     - totalPointsDistributed: SUM of amount from transactions WHERE amount > 0
     - totalReferrals: COUNT from referrals table
   - Wrap in try/catch, return 500 on error
   - Use Supabase .select('*', { count: 'exact', head: true }) pattern for counts

2. Create `src/app/admin/dashboard/page.tsx`:
   - 'use client' directive
   - useState for overview data, loading state
   - useEffect to fetch from /api/admin/analytics/overview
   - Display header: "Analytics Dashboard" with last updated timestamp
   - Grid of 4 MetricCards (responsive: 2 cols mobile, 4 cols lg):
     - Total Users
     - Wallets Connected (with conversion rate as change)
     - Total Points Distributed (format with commas)
     - Total Referrals
   - Show loading skeleton while fetching
   - Auto-refresh every 60 seconds (setInterval)
  </action>
  <verify>
    - `curl http://localhost:3000/api/admin/analytics/overview` returns JSON with all 5 fields
    - Dashboard page renders 4 MetricCards with real data
  </verify>
  <done>
    - Overview API returns real metrics from Supabase
    - Dashboard displays 4 key metrics in responsive grid
    - Auto-refresh updates data every 60 seconds
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build` completes without errors
2. Admin route protected: Non-admin sees "Access Denied"
3. Overview API works: Returns valid JSON with all metric fields
4. Dashboard displays: MetricCards show real data from database
5. Responsive layout: Grid adapts from 2 cols (mobile) to 4 cols (desktop)
</verification>

<success_criteria>
- All charting dependencies installed (recharts, date-fns, @uiw/react-heat-map, react-csv)
- Admin route protection via AdminGuard component
- Overview API endpoint returning 5 key metrics
- Dashboard page with 4 MetricCards displaying live data
- 60-second auto-refresh working
</success_criteria>

<output>
After completion, create `.planning/phases/09-analytics-dashboard/09-01-SUMMARY.md`
</output>
