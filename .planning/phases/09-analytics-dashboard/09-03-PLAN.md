---
phase: 09-analytics-dashboard
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/app/api/admin/analytics/engagement/route.ts
  - src/app/api/admin/analytics/retention/route.ts
  - src/app/api/admin/analytics/features/route.ts
  - src/components/admin/charts/EngagementHeatmap.tsx
  - src/components/admin/charts/RetentionChart.tsx
  - src/components/admin/charts/FeatureUsageChart.tsx
  - src/app/admin/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "Engagement heatmap shows activity by day of week and hour"
    - "Retention chart displays D1/D7/D30 curves"
    - "Feature usage chart shows breakdown by activity type"
  artifacts:
    - path: "src/app/api/admin/analytics/engagement/route.ts"
      provides: "Activity heatmap data by day/hour"
      exports: ["GET"]
    - path: "src/app/api/admin/analytics/retention/route.ts"
      provides: "Retention cohort data"
      exports: ["GET"]
    - path: "src/app/api/admin/analytics/features/route.ts"
      provides: "Feature usage breakdown"
      exports: ["GET"]
    - path: "src/components/admin/charts/EngagementHeatmap.tsx"
      provides: "GitHub-style activity heatmap"
      exports: ["EngagementHeatmap"]
    - path: "src/components/admin/charts/RetentionChart.tsx"
      provides: "Line chart for retention curves"
      exports: ["RetentionChart"]
  key_links:
    - from: "src/components/admin/charts/EngagementHeatmap.tsx"
      to: "@uiw/react-heat-map"
      via: "HeatMap component import"
      pattern: "from.*@uiw/react-heat-map"
    - from: "src/app/api/admin/analytics/features/route.ts"
      to: "transactions table"
      via: "GROUP BY reason query"
      pattern: "from.*transactions"
---

<objective>
Build engagement and retention visualizations: activity heatmap showing when users are active, retention curves (D1/D7/D30), and feature usage breakdown.

Purpose: These charts reveal user behavior patterns - when to engage, how well we retain, and which features drive value.
Output: Dashboard extended with 3 more charts for engagement analytics.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-analytics-dashboard/09-RESEARCH.md
@.planning/phases/09-analytics-dashboard/09-01-SUMMARY.md

# Database schema
@scoreboard_v4_migration.sql

# API patterns
@src/app/api/admin/analytics/overview/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create engagement and retention API endpoints</name>
  <files>
    - src/app/api/admin/analytics/engagement/route.ts
    - src/app/api/admin/analytics/retention/route.ts
  </files>
  <action>
1. Create `src/app/api/admin/analytics/engagement/route.ts`:
   - Query transactions table for activity timestamps
   - Aggregate by date (YYYY-MM-DD format) and count
   - Return array of { date: string, count: number } for last 90 days
   - This feeds the @uiw/react-heat-map component
   - Fill missing days with count: 0

2. Create `src/app/api/admin/analytics/retention/route.ts`:
   - Query profiles for created_at and last_active_at
   - Group users into weekly cohorts (e.g., "2026-W04")
   - Calculate retention for each cohort:
     - signups: total users in cohort
     - d1: users active 1+ days after signup
     - d7: users active 7+ days after signup
     - d30: users active 30+ days after signup
   - Return array of { cohort: string, signups: number, d1: number, d7: number, d30: number }
   - Calculate percentages: (d1/signups * 100).toFixed(1)
   - Use date-fns: getISOWeek, getISOWeekYear for cohort keys
   - Only include cohorts old enough for each metric (skip d30 for cohorts < 30 days old)
  </action>
  <verify>
    - `curl /api/admin/analytics/engagement` returns array with date and count
    - `curl /api/admin/analytics/retention` returns cohort data with d1/d7/d30
  </verify>
  <done>
    - Engagement API returns 90 days of activity counts for heatmap
    - Retention API returns weekly cohorts with D1/D7/D30 percentages
  </done>
</task>

<task type="auto">
  <name>Task 2: Create feature usage API and chart components</name>
  <files>
    - src/app/api/admin/analytics/features/route.ts
    - src/components/admin/charts/EngagementHeatmap.tsx
    - src/components/admin/charts/RetentionChart.tsx
    - src/components/admin/charts/FeatureUsageChart.tsx
  </files>
  <action>
1. Create `src/app/api/admin/analytics/features/route.ts`:
   - Query transactions grouped by reason (this IS feature usage)
   - Count distinct users per reason (unique users, not total transactions)
   - Return array of { feature: string, users: number, transactions: number }
   - Map reason to friendly names:
     - daily_spin -> "Daily Spin"
     - daily_login -> "Daily Login"
     - referral -> "Referrals"
     - wallet_connect -> "Wallet Connect"
     - channel_join -> "Channel Join"
     - welcome_bonus -> "Welcome Bonus"
   - Sort by users DESC

2. Create `src/components/admin/charts/EngagementHeatmap.tsx`:
   - 'use client' directive
   - Import HeatMap from '@uiw/react-heat-map'
   - Props: data: { date: string, count: number }[]
   - Configure startDate (90 days ago) and endDate (today)
   - Use panelColors for dark theme:
     - 0: '#161b22' (no activity)
     - 2: '#0e4429', 4: '#006d32', 8: '#26a641', 12: '#39d353'
   - rectSize: 12, space: 3, rounded corners (rx: 2)
   - weekLabels: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']

3. Create `src/components/admin/charts/RetentionChart.tsx`:
   - 'use client' directive
   - Import LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer from recharts
   - Props: data: { cohort: string, d1: number, d7: number, d30: number }[]
   - Three lines: D1 (blue), D7 (purple), D30 (green)
   - Y-axis: 0-100 (percentage)
   - X-axis: cohort week labels
   - Dark theme tooltips

4. Create `src/components/admin/charts/FeatureUsageChart.tsx`:
   - 'use client' directive
   - Use PieChart with Pie, Cell, Tooltip, ResponsiveContainer, Legend from recharts
   - Props: data: { feature: string, users: number }[]
   - Color palette: ['#eab308', '#22c55e', '#3b82f6', '#8b5cf6', '#f97316', '#ec4899']
   - Show percentage labels
   - Legend at bottom
  </action>
  <verify>
    - All chart components have 'use client' directive
    - EngagementHeatmap imports from @uiw/react-heat-map
    - Feature usage API returns feature breakdown
  </verify>
  <done>
    - Feature usage API returns user counts by activity type
    - EngagementHeatmap renders GitHub-style calendar heatmap
    - RetentionChart shows D1/D7/D30 curves over cohorts
    - FeatureUsageChart shows pie chart of feature adoption
  </done>
</task>

<task type="auto">
  <name>Task 3: Extend dashboard with engagement charts</name>
  <files>
    - src/app/admin/dashboard/page.tsx
  </files>
  <action>
1. Add fetches for new APIs:
   - /api/admin/analytics/engagement
   - /api/admin/analytics/retention
   - /api/admin/analytics/features
   - Add to existing Promise.all

2. Add new chart sections after existing ones:
   - Section: "User Engagement" (full width)
     - EngagementHeatmap showing last 90 days
   - Section: "Retention Analysis" (left half on lg)
     - RetentionChart with D1/D7/D30 lines
   - Section: "Feature Adoption" (right half on lg)
     - FeatureUsageChart pie chart

3. Layout structure:
   - EngagementHeatmap in scrollable container (overflow-x-auto) for mobile
   - 2-column grid for Retention + Features on lg screens
   - Consistent card styling: bg-zinc-900 border border-zinc-800 rounded-xl p-4

4. Add loading skeletons for new sections
  </action>
  <verify>
    - Dashboard displays all 6 charts (3 from Plan 02 + 3 new)
    - Heatmap scrolls horizontally on mobile
    - Retention and Feature charts show real data
  </verify>
  <done>
    - Dashboard displays EngagementHeatmap with 90-day activity
    - RetentionChart shows cohort retention curves
    - FeatureUsageChart shows pie chart of feature adoption
    - All charts responsive and styled consistently
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build` completes without errors
2. Engagement API returns 90 days of data
3. Retention API calculates correct D1/D7/D30 percentages
4. Feature usage API groups transactions by reason
5. All charts render without hydration errors
6. Heatmap displays calendar grid correctly
</verification>

<success_criteria>
- Engagement heatmap shows daily activity levels for last 90 days
- Retention chart displays D1/D7/D30 curves by weekly cohort
- Feature usage pie chart shows adoption breakdown
- All charts use consistent dark theme
- Mobile users can scroll heatmap horizontally
</success_criteria>

<output>
After completion, create `.planning/phases/09-analytics-dashboard/09-03-SUMMARY.md`
</output>
