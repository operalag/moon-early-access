---
phase: 09-analytics-dashboard
plan: 04
type: execute
wave: 3
depends_on: ["09-02", "09-03"]
files_modified:
  - src/app/api/admin/analytics/campaigns/route.ts
  - src/app/api/admin/analytics/referrals/route.ts
  - src/components/admin/CampaignTable.tsx
  - src/components/admin/ReferralStats.tsx
  - src/app/admin/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "Campaign table shows all campaigns with user counts"
    - "Referral stats show top referrers and network size"
    - "Dashboard displays marketing performance section"
  artifacts:
    - path: "src/app/api/admin/analytics/campaigns/route.ts"
      provides: "Campaign performance data"
      exports: ["GET"]
    - path: "src/app/api/admin/analytics/referrals/route.ts"
      provides: "Referral network statistics"
      exports: ["GET"]
    - path: "src/components/admin/CampaignTable.tsx"
      provides: "Sortable campaign performance table"
      exports: ["CampaignTable"]
    - path: "src/components/admin/ReferralStats.tsx"
      provides: "Referral leaderboard and stats"
      exports: ["ReferralStats"]
  key_links:
    - from: "src/app/api/admin/analytics/campaigns/route.ts"
      to: "campaign_attributions table"
      via: "GROUP BY campaign_id query"
      pattern: "from.*campaign_attributions"
    - from: "src/app/api/admin/analytics/referrals/route.ts"
      to: "referrals table"
      via: "GROUP BY referrer_id query"
      pattern: "from.*referrals"
---

<objective>
Build campaign and referral tracking: campaign performance table showing attribution counts, and referral statistics showing top referrers and network metrics.

Purpose: Track marketing ROI through campaign attribution and viral growth through referral performance.
Output: Dashboard extended with Campaign Performance table and Referral Network section.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-analytics-dashboard/09-RESEARCH.md
@.planning/phases/09-analytics-dashboard/09-01-SUMMARY.md
@.planning/phases/09-analytics-dashboard/09-02-SUMMARY.md

# Campaign table schema
@supabase/migrations/20260127173157_campaign_attributions.sql

# Referral schema
@referrals_migration.sql

# Existing campaign API pattern
@src/app/api/debug/campaigns/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create campaigns and referrals API endpoints</name>
  <files>
    - src/app/api/admin/analytics/campaigns/route.ts
    - src/app/api/admin/analytics/referrals/route.ts
  </files>
  <action>
1. Create `src/app/api/admin/analytics/campaigns/route.ts`:
   - Query campaign_attributions, GROUP BY campaign_id
   - Return array of:
     - campaign_id: string
     - users: number (count)
     - first_attribution: string (MIN created_at)
     - last_attribution: string (MAX created_at)
   - Sort by users DESC
   - Include summary: { total_campaigns: number, total_attributed_users: number }

2. Create `src/app/api/admin/analytics/referrals/route.ts`:
   - Query referrals table with joins to get referrer names
   - Return:
     - summary: { total_referrals: number, unique_referrers: number, avg_per_referrer: number }
     - top_referrers: array of top 10 referrers
       - referrer_id: number
       - referrer_name: string (join profiles.first_name)
       - count: number (COUNT of referees)
     - network_depth: { tier1: number } (for now, just count of direct referrals)
   - Join profiles ON referrals.referrer_id = profiles.telegram_id for names
  </action>
  <verify>
    - `curl /api/admin/analytics/campaigns` returns campaigns array with user counts
    - `curl /api/admin/analytics/referrals` returns summary and top_referrers
  </verify>
  <done>
    - Campaigns API returns campaign performance with attribution counts
    - Referrals API returns top referrers and network summary
  </done>
</task>

<task type="auto">
  <name>Task 2: Create campaign and referral components</name>
  <files>
    - src/components/admin/CampaignTable.tsx
    - src/components/admin/ReferralStats.tsx
  </files>
  <action>
1. Create `src/components/admin/CampaignTable.tsx`:
   - 'use client' directive
   - Props: data: { campaign_id: string, users: number, first_attribution: string, last_attribution: string }[]
   - Sortable table with columns: Campaign ID, Users, First Seen, Last Seen
   - Default sort by users DESC
   - useState for sortField and sortDirection
   - Table styling:
     - Table: w-full text-sm
     - Header: bg-zinc-800 text-zinc-400 uppercase text-xs
     - Rows: bg-zinc-900 border-b border-zinc-800
     - Hover: hover:bg-zinc-800
   - Format dates nicely (use date-fns format)
   - Show "No campaigns yet" if empty

2. Create `src/components/admin/ReferralStats.tsx`:
   - 'use client' directive
   - Props:
     - summary: { total_referrals: number, unique_referrers: number, avg_per_referrer: number }
     - topReferrers: { referrer_id: number, referrer_name: string, count: number }[]
   - Layout:
     - Top section: 3 mini MetricCards for summary stats (inline)
     - Bottom section: "Top Referrers" leaderboard
   - Leaderboard styling:
     - Numbered list (1, 2, 3...)
     - Avatar placeholder (first letter of name)
     - Name and count
     - Top 3 get special styling (gold, silver, bronze)
   - Show "No referrals yet" if empty
  </action>
  <verify>
    - CampaignTable renders sortable table
    - ReferralStats shows summary and leaderboard
    - Both components handle empty states
  </verify>
  <done>
    - CampaignTable displays sortable campaign performance
    - ReferralStats shows summary metrics and top 10 referrers
    - Empty states handled gracefully
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate marketing section into dashboard</name>
  <files>
    - src/app/admin/dashboard/page.tsx
  </files>
  <action>
1. Add fetches for marketing APIs:
   - /api/admin/analytics/campaigns
   - /api/admin/analytics/referrals
   - Add to existing Promise.all

2. Add "Marketing Performance" section after engagement charts:
   - Section header: "Marketing Performance"
   - 2-column grid on lg:
     - Left: CampaignTable (campaign performance)
     - Right: ReferralStats (referral network)
   - Full width on mobile (stacked)

3. Card styling consistent with other sections:
   - bg-zinc-900 border border-zinc-800 rounded-xl p-4
   - Section title inside card: text-base font-semibold text-white mb-3

4. Add loading skeletons for marketing section
  </action>
  <verify>
    - Dashboard displays CampaignTable with real data
    - Dashboard displays ReferralStats with top referrers
    - Layout responsive (2-col on lg, stacked on mobile)
  </verify>
  <done>
    - Dashboard displays Marketing Performance section
    - CampaignTable shows all campaigns with attribution counts
    - ReferralStats shows referral network summary and leaderboard
    - Layout responsive and consistent with other sections
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build` completes without errors
2. Campaigns API returns data from campaign_attributions table
3. Referrals API returns top referrers with names
4. CampaignTable sorts correctly when clicking headers
5. ReferralStats shows summary and top 10
6. Empty states display properly when no data
</verification>

<success_criteria>
- Campaign table shows all campaigns sorted by user count
- Referral stats display total referrals, unique referrers, avg per referrer
- Top 10 referrers shown with names and counts
- Marketing section responsive and styled consistently
- Empty states handled when no campaigns or referrals exist
</success_criteria>

<output>
After completion, create `.planning/phases/09-analytics-dashboard/09-04-SUMMARY.md`
</output>
