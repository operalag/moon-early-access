---
phase: 09-analytics-dashboard
plan: 04
type: execute
wave: 3
depends_on: ["09-02", "09-03"]
files_modified:
  - src/app/api/admin/analytics/campaigns/route.ts
  - src/app/api/admin/analytics/referrals/route.ts
  - src/components/admin/CampaignTable.tsx
  - src/components/admin/ReferralStats.tsx
  - src/components/admin/LeaderboardTrends.tsx
  - src/app/admin/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "Campaign table shows all campaigns with user counts"
    - "Referral stats show top referrers and network size"
    - "Dashboard displays marketing performance section"
    - "Leaderboard trends show top movers and position changes"
  artifacts:
    - path: "src/app/api/admin/analytics/campaigns/route.ts"
      provides: "Campaign performance data"
      exports: ["GET"]
    - path: "src/app/api/admin/analytics/referrals/route.ts"
      provides: "Referral network statistics"
      exports: ["GET"]
    - path: "src/components/admin/CampaignTable.tsx"
      provides: "Sortable campaign performance table"
      exports: ["CampaignTable"]
    - path: "src/components/admin/ReferralStats.tsx"
      provides: "Referral leaderboard and stats"
      exports: ["ReferralStats"]
    - path: "src/components/admin/LeaderboardTrends.tsx"
      provides: "Leaderboard position changes visualization"
      exports: ["LeaderboardTrends"]
  key_links:
    - from: "src/app/api/admin/analytics/campaigns/route.ts"
      to: "campaign_attributions table"
      via: "GROUP BY campaign_id query"
      pattern: "from.*campaign_attributions"
    - from: "src/app/api/admin/analytics/referrals/route.ts"
      to: "referrals table"
      via: "GROUP BY referrer_id query"
      pattern: "from.*referrals"
    - from: "src/components/admin/LeaderboardTrends.tsx"
      to: "leaderboard_buckets table"
      via: "Comparing daily snapshots"
      pattern: "leaderboard_buckets"
---

<objective>
Build campaign and referral tracking: campaign performance table showing attribution counts, referral statistics showing top referrers and network metrics, and leaderboard dynamics showing position changes over time.

Purpose: Track marketing ROI through campaign attribution, viral growth through referral performance, and engagement through leaderboard dynamics.
Output: Dashboard extended with Campaign Performance table, Referral Network section, and Leaderboard Trends visualization.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-analytics-dashboard/09-RESEARCH.md
@.planning/phases/09-analytics-dashboard/09-01-SUMMARY.md
@.planning/phases/09-analytics-dashboard/09-02-SUMMARY.md

# Campaign table schema
@supabase/migrations/20260127173157_campaign_attributions.sql

# Referral schema
@referrals_migration.sql

# Leaderboard buckets schema (for trends)
@supabase/migrations/scoreboard_v4_migration.sql

# Existing campaign API pattern
@src/app/api/debug/campaigns/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create campaigns and referrals API endpoints</name>
  <files>
    - src/app/api/admin/analytics/campaigns/route.ts
    - src/app/api/admin/analytics/referrals/route.ts
  </files>
  <action>
1. Create `src/app/api/admin/analytics/campaigns/route.ts`:
   - Query campaign_attributions, GROUP BY campaign_id
   - Return array of:
     - campaign_id: string
     - users: number (count)
     - first_attribution: string (MIN created_at)
     - last_attribution: string (MAX created_at)
   - Sort by users DESC
   - Include summary: { total_campaigns: number, total_attributed_users: number }

2. Create `src/app/api/admin/analytics/referrals/route.ts`:
   - Query referrals table with joins to get referrer names
   - Return:
     - summary: { total_referrals: number, unique_referrers: number, avg_per_referrer: number }
     - top_referrers: array of top 10 referrers
       - referrer_id: number
       - referrer_name: string (join profiles.first_name)
       - count: number (COUNT of referees)
     - network_depth: { tier1: number } (for now, just count of direct referrals)
     - leaderboard_trends: array of top movers (see Task 2 for data structure)
   - Join profiles ON referrals.referrer_id = profiles.telegram_id for names
   - For leaderboard_trends: query leaderboard_buckets for last 7 days, compare positions
  </action>
  <verify>
    - `curl /api/admin/analytics/campaigns` returns campaigns array with user counts
    - `curl /api/admin/analytics/referrals` returns summary, top_referrers, and leaderboard_trends
  </verify>
  <done>
    - Campaigns API returns campaign performance with attribution counts
    - Referrals API returns top referrers, network summary, and leaderboard trends data
  </done>
</task>

<task type="auto">
  <name>Task 2: Create campaign, referral, and leaderboard trend components</name>
  <files>
    - src/components/admin/CampaignTable.tsx
    - src/components/admin/ReferralStats.tsx
    - src/components/admin/LeaderboardTrends.tsx
  </files>
  <action>
1. Create `src/components/admin/CampaignTable.tsx`:
   - 'use client' directive
   - Props: data: { campaign_id: string, users: number, first_attribution: string, last_attribution: string }[]
   - Sortable table with columns: Campaign ID, Users, First Seen, Last Seen
   - Default sort by users DESC
   - useState for sortField and sortDirection
   - Table styling:
     - Table: w-full text-sm
     - Header: bg-zinc-800 text-zinc-400 uppercase text-xs
     - Rows: bg-zinc-900 border-b border-zinc-800
     - Hover: hover:bg-zinc-800
   - Format dates nicely (use date-fns format)
   - Show "No campaigns yet" if empty

2. Create `src/components/admin/ReferralStats.tsx`:
   - 'use client' directive
   - Props:
     - summary: { total_referrals: number, unique_referrers: number, avg_per_referrer: number }
     - topReferrers: { referrer_id: number, referrer_name: string, count: number }[]
   - Layout:
     - Top section: 3 mini MetricCards for summary stats (inline)
     - Bottom section: "Top Referrers" leaderboard
   - Leaderboard styling:
     - Numbered list (1, 2, 3...)
     - Avatar placeholder (first letter of name)
     - Name and count
     - Top 3 get special styling (gold, silver, bronze)
   - Show "No referrals yet" if empty

3. Create `src/components/admin/LeaderboardTrends.tsx`:
   - 'use client' directive
   - Props:
     - trends: { telegram_id: number, name: string, current_rank: number, previous_rank: number, change: number }[]
   - Display "Top Movers" showing users with biggest position changes in last 7 days
   - Layout:
     - List of top 5 movers (biggest positive change)
     - Show: rank change arrow (up green, down red), name, current rank, change amount
     - Example: "^ +12" for user who moved up 12 spots
   - Calculate change = previous_rank - current_rank (positive = moved up)
   - Styling:
     - Card: bg-zinc-900 border border-zinc-800 rounded-xl p-4
     - Up arrow: text-green-500
     - Down arrow: text-red-500
   - Show "No movement data yet" if empty or insufficient data
  </action>
  <verify>
    - CampaignTable renders sortable table
    - ReferralStats shows summary and leaderboard
    - LeaderboardTrends shows top movers with position changes
    - All components handle empty states
  </verify>
  <done>
    - CampaignTable displays sortable campaign performance
    - ReferralStats shows summary metrics and top 10 referrers
    - LeaderboardTrends shows top 5 movers with rank changes
    - Empty states handled gracefully
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate marketing section into dashboard</name>
  <files>
    - src/app/admin/dashboard/page.tsx
  </files>
  <action>
1. Add fetches for marketing APIs:
   - /api/admin/analytics/campaigns
   - /api/admin/analytics/referrals
   - Add to existing Promise.all

2. Add "Marketing Performance" section after engagement charts:
   - Section header: "Marketing Performance"
   - 2-column grid on lg:
     - Left: CampaignTable (campaign performance)
     - Right: ReferralStats (referral network)
   - Full width on mobile (stacked)

3. Add "Leaderboard Dynamics" section:
   - Place after Marketing Performance section
   - Single card with LeaderboardTrends component
   - Section header: "Leaderboard Dynamics"
   - Shows top movers from referrals API response (leaderboard_trends field)

4. Card styling consistent with other sections:
   - bg-zinc-900 border border-zinc-800 rounded-xl p-4
   - Section title inside card: text-base font-semibold text-white mb-3

5. Add loading skeletons for marketing and leaderboard sections
  </action>
  <verify>
    - Dashboard displays CampaignTable with real data
    - Dashboard displays ReferralStats with top referrers
    - Dashboard displays LeaderboardTrends with top movers
    - Layout responsive (2-col on lg, stacked on mobile)
  </verify>
  <done>
    - Dashboard displays Marketing Performance section
    - Dashboard displays Leaderboard Dynamics section
    - CampaignTable shows all campaigns with attribution counts
    - ReferralStats shows referral network summary and leaderboard
    - LeaderboardTrends shows position changes over time
    - Layout responsive and consistent with other sections
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build` completes without errors
2. Campaigns API returns data from campaign_attributions table
3. Referrals API returns top referrers with names and leaderboard trends
4. CampaignTable sorts correctly when clicking headers
5. ReferralStats shows summary and top 10
6. LeaderboardTrends shows top movers with position changes
7. Empty states display properly when no data
</verification>

<success_criteria>
- Campaign table shows all campaigns sorted by user count
- Referral stats display total referrals, unique referrers, avg per referrer
- Top 10 referrers shown with names and counts
- Leaderboard trends show top 5 movers with rank change indicators
- Marketing section responsive and styled consistently
- Leaderboard dynamics section shows position changes over time
- Empty states handled when no campaigns, referrals, or movement data exist
</success_criteria>

<output>
After completion, create `.planning/phases/09-analytics-dashboard/09-04-SUMMARY.md`
</output>
