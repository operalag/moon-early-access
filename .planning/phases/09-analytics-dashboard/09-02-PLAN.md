---
phase: 09-analytics-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/app/api/admin/analytics/users/route.ts
  - src/app/api/admin/analytics/funnel/route.ts
  - src/app/api/admin/analytics/points/route.ts
  - src/components/admin/charts/UserGrowthChart.tsx
  - src/components/admin/charts/WalletFunnel.tsx
  - src/components/admin/charts/PointsEconomyChart.tsx
  - src/app/admin/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "User growth chart shows total users over time"
    - "Wallet funnel shows conversion from signup to wallet connection"
    - "Points economy chart shows distribution by reason"
  artifacts:
    - path: "src/app/api/admin/analytics/users/route.ts"
      provides: "User acquisition time series"
      exports: ["GET"]
    - path: "src/app/api/admin/analytics/funnel/route.ts"
      provides: "Wallet conversion funnel data"
      exports: ["GET"]
    - path: "src/app/api/admin/analytics/points/route.ts"
      provides: "Points economy breakdown"
      exports: ["GET"]
    - path: "src/components/admin/charts/UserGrowthChart.tsx"
      provides: "Line chart for user growth"
      exports: ["UserGrowthChart"]
    - path: "src/components/admin/charts/WalletFunnel.tsx"
      provides: "Funnel chart for wallet conversion"
      exports: ["WalletFunnel"]
    - path: "src/components/admin/charts/PointsEconomyChart.tsx"
      provides: "Pie/bar chart for points breakdown"
      exports: ["PointsEconomyChart"]
  key_links:
    - from: "src/app/admin/dashboard/page.tsx"
      to: "src/components/admin/charts/UserGrowthChart.tsx"
      via: "import and render with fetched data"
      pattern: "UserGrowthChart"
    - from: "src/app/api/admin/analytics/users/route.ts"
      to: "supabaseAdmin"
      via: "profiles query with date grouping"
      pattern: "from.*profiles"
---

<objective>
Build the core visualization charts: user growth over time, wallet conversion funnel, and points economy breakdown.

Purpose: These three charts provide the most actionable insights - growth trajectory, conversion health, and economy balance.
Output: Dashboard with 3 interactive Recharts visualizations displaying real data.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-analytics-dashboard/09-RESEARCH.md
@.planning/phases/09-analytics-dashboard/09-01-SUMMARY.md

# Database schema
@scoreboard_v4_migration.sql

# Existing API patterns
@src/app/api/admin/analytics/overview/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user growth and funnel API endpoints</name>
  <files>
    - src/app/api/admin/analytics/users/route.ts
    - src/app/api/admin/analytics/funnel/route.ts
  </files>
  <action>
1. Create `src/app/api/admin/analytics/users/route.ts`:
   - GET handler with optional query params: days (default 30)
   - Query profiles table, group by DATE(created_at)
   - Return array of { date: string, total: number, cumulative: number }
   - Use date-fns for date formatting (format, subDays, eachDayOfInterval)
   - Fill in missing days with previous cumulative value (no gaps in chart)
   - Pattern: SELECT date_trunc('day', created_at) as day, COUNT(*) FROM profiles GROUP BY day ORDER BY day

2. Create `src/app/api/admin/analytics/funnel/route.ts`:
   - GET handler
   - Return funnel stages:
     - stage1: { name: "Total Users", value: COUNT(*) from profiles, fill: "#3b82f6" }
     - stage2: { name: "Channel Joined", value: COUNT(*) WHERE has_joined_channel=true, fill: "#8b5cf6" }
     - stage3: { name: "Wallet Connected", value: COUNT(*) WHERE is_wallet_connected=true, fill: "#22c55e" }
   - Calculate conversionRates between stages (stage2/stage1, stage3/stage2)
   - Return { stages: [...], conversionRates: { toChannel: X, toWallet: Y } }
  </action>
  <verify>
    - `curl /api/admin/analytics/users` returns array with date, total, cumulative fields
    - `curl /api/admin/analytics/funnel` returns stages array with 3 items
  </verify>
  <done>
    - Users API returns daily user counts for last 30 days
    - Funnel API returns 3-stage conversion data with rates
  </done>
</task>

<task type="auto">
  <name>Task 2: Create points economy API and chart components</name>
  <files>
    - src/app/api/admin/analytics/points/route.ts
    - src/components/admin/charts/UserGrowthChart.tsx
    - src/components/admin/charts/WalletFunnel.tsx
    - src/components/admin/charts/PointsEconomyChart.tsx
  </files>
  <action>
1. Create `src/app/api/admin/analytics/points/route.ts`:
   - Query transactions table, GROUP BY reason
   - Return array of { reason: string, distributed: number, transactions: number }
   - Order by distributed DESC
   - Calculate totals for distributed and transactions

2. Create `src/components/admin/charts/UserGrowthChart.tsx`:
   - 'use client' directive (CRITICAL for Recharts)
   - Import LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend from recharts
   - Props: data: { date: string, total: number, cumulative: number }[]
   - ResponsiveContainer with 100% width, 300px height
   - Dark theme: CartesianGrid stroke="#333", axis stroke="#666"
   - Two lines: cumulative (yellow-500 #eab308) and total (green-500 #22c55e)
   - Tooltip with dark background (#1a1a1a, border #333)

3. Create `src/components/admin/charts/WalletFunnel.tsx`:
   - 'use client' directive
   - Import FunnelChart, Funnel, Cell, LabelList, ResponsiveContainer, Tooltip from recharts
   - Props: data: { name: string, value: number, fill: string }[]
   - ResponsiveContainer 100% width, 300px height
   - LabelList position="right" for stage names
   - Tooltip with dark theme

4. Create `src/components/admin/charts/PointsEconomyChart.tsx`:
   - 'use client' directive
   - Use BarChart (horizontal) from recharts
   - Import BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer from recharts
   - Props: data: { reason: string, distributed: number }[]
   - Format reason names nicely (daily_spin -> "Daily Spin", wallet_connect -> "Wallet Connect")
   - Horizontal layout (layout="vertical") for readability
   - Yellow bars (#eab308), dark theme tooltips
  </action>
  <verify>
    - All 3 chart components use 'use client' directive
    - Charts import from 'recharts' correctly
    - Points API returns breakdown by reason
  </verify>
  <done>
    - Points economy API returns breakdown by transaction reason
    - UserGrowthChart renders line chart with cumulative and daily totals
    - WalletFunnel renders 3-stage funnel visualization
    - PointsEconomyChart renders horizontal bar chart of points by reason
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate charts into dashboard page</name>
  <files>
    - src/app/admin/dashboard/page.tsx
  </files>
  <action>
1. Update dashboard page to fetch all data:
   - Keep existing overview fetch
   - Add fetches for /users, /funnel, /points APIs
   - Use Promise.all for parallel fetching
   - Individual loading states or unified skeleton

2. Add chart sections below MetricCards:
   - Section header: "User Growth" with date range info
   - UserGrowthChart with fetched data
   - Section header: "Conversion Funnel"
   - WalletFunnel with conversion rates displayed below
   - Section header: "Points Economy"
   - PointsEconomyChart with total distributed

3. Layout structure:
   - Full width for UserGrowthChart
   - 2-column grid for Funnel and Points (lg breakpoint)
   - Each chart in a card: bg-zinc-900 border-zinc-800 rounded-xl p-4
   - Section headers: text-lg font-semibold text-white mb-4

4. Add loading skeletons:
   - Use animate-pulse bg-zinc-800 for chart placeholders
   - Match chart dimensions (300px height)
  </action>
  <verify>
    - Dashboard loads and displays all 3 charts
    - Charts render with real data from APIs
    - Responsive layout works (full width on mobile, grid on desktop)
  </verify>
  <done>
    - Dashboard displays UserGrowthChart, WalletFunnel, PointsEconomyChart
    - All charts show real data from Supabase
    - Loading states display while fetching
    - Responsive grid layout adapts to screen size
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build` completes without errors
2. All 3 API endpoints return valid data
3. Charts render without hydration errors
4. Dashboard shows real metrics from database
5. Charts are interactive (tooltips work on hover)
</verification>

<success_criteria>
- User growth chart shows cumulative and daily user counts over 30 days
- Wallet funnel displays 3-stage conversion with percentages
- Points economy chart shows distribution by reason (spin, referral, etc.)
- All charts use dark theme consistent with app design
- Charts are responsive and work on mobile
</success_criteria>

<output>
After completion, create `.planning/phases/09-analytics-dashboard/09-02-SUMMARY.md`
</output>
