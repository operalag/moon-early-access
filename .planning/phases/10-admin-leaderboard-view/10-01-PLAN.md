---
phase: 10-admin-leaderboard-view
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/admin/analytics/leaderboards/route.ts
  - src/components/admin/LeaderboardTable.tsx
  - src/app/admin/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can see top 10 users for overall (all-time) leaderboard"
    - "Admin can see top 10 users for weekly leaderboard"
    - "Admin can see top 10 users for daily leaderboard"
    - "Each leaderboard shows name, username, wallet address, and points"
    - "Admin can export each leaderboard to CSV"
  artifacts:
    - path: "src/app/api/admin/analytics/leaderboards/route.ts"
      provides: "Leaderboards API returning all 3 timeframes"
      exports: ["GET"]
    - path: "src/components/admin/LeaderboardTable.tsx"
      provides: "Reusable leaderboard display with export"
      exports: ["LeaderboardTable"]
    - path: "src/app/admin/dashboard/page.tsx"
      provides: "Dashboard with leaderboard section"
      contains: "LeaderboardTable"
  key_links:
    - from: "src/app/admin/dashboard/page.tsx"
      to: "/api/admin/analytics/leaderboards"
      via: "fetch in fetchData"
      pattern: "fetch.*api/admin/analytics/leaderboards"
    - from: "src/components/admin/LeaderboardTable.tsx"
      to: "ExportButton"
      via: "import and render"
      pattern: "import.*ExportButton"
---

<objective>
Add admin leaderboard view displaying top 10 users for overall, weekly, and daily timeframes with user details and CSV export.

Purpose: Enable admins to quickly see top performers across different time periods with full user details including wallet addresses for potential rewards or outreach.

Output: New API route, LeaderboardTable component, and dashboard integration showing 3 leaderboard cards.
</objective>

<execution_context>
@/Users/tonicaradonna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tonicaradonna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-admin-leaderboard-view/10-RESEARCH.md

# Existing patterns to follow
@src/app/api/admin/analytics/referrals/route.ts
@src/components/admin/ReferralStats.tsx
@src/components/admin/ExportButton.tsx
@src/app/admin/dashboard/page.tsx
@src/app/api/leaderboard/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Leaderboards API</name>
  <files>src/app/api/admin/analytics/leaderboards/route.ts</files>
  <action>
Create GET endpoint returning all 3 leaderboards in a single response.

Structure the response as:
```typescript
interface LeaderboardEntry {
  rank: number;
  first_name: string;
  username: string | null;
  wallet_address: string | null;
  points: number;
}

interface LeaderboardsResponse {
  overall: LeaderboardEntry[];
  weekly: LeaderboardEntry[];
  daily: LeaderboardEntry[];
  generated_at: string;
}
```

Query patterns:
1. **Overall (all-time):** Query `profiles` table ordered by `total_points` DESC, limit 10. Select `telegram_id, first_name, username, total_points, ton_wallet_address`.

2. **Daily:** Query `leaderboard_buckets` with `period_type='daily'` and `period_key=YYYY-MM-DD` (today). Use FK join: `profiles!leaderboard_buckets_user_id_fkey(first_name, username, ton_wallet_address)`. Order by `points` DESC, limit 10.

3. **Weekly:** Same as daily but `period_type='weekly'` and `period_key=YYYY-WNN` format. Use date-fns `getISOWeek` and `getISOWeekYear` to compute the key correctly.

Weekly key format: `${getISOWeekYear(now)}-W${String(getISOWeek(now)).padStart(2, '0')}`

Map results to add `rank: index + 1` and normalize field names.

Handle null wallet addresses gracefully (keep as null in response, UI will display "Not connected").

Follow existing admin API patterns from referrals/route.ts for error handling and response structure.
  </action>
  <verify>
curl http://localhost:3000/api/admin/analytics/leaderboards (with valid admin auth cookie) returns JSON with overall, weekly, daily arrays each containing up to 10 entries with rank, first_name, username, wallet_address, points fields.
  </verify>
  <done>API returns 3 leaderboards with correct data structure; handles edge cases (empty buckets, null wallets).</done>
</task>

<task type="auto">
  <name>Task 2: Create LeaderboardTable Component</name>
  <files>src/components/admin/LeaderboardTable.tsx</files>
  <action>
Create a reusable component for displaying a single leaderboard with export functionality.

Props interface:
```typescript
interface LeaderboardTableProps {
  title: string;           // e.g., "Overall", "Weekly", "Daily"
  data: LeaderboardEntry[];
  filename: string;        // CSV filename prefix
}
```

Component features:
1. **Header:** Title + ExportButton aligned to right (follow Points Economy pattern from dashboard)

2. **Medal styling:** Ranks 1-3 get gold/silver/bronze badges (copy from ReferralStats):
   - 1: `bg-yellow-500 text-black` (Gold)
   - 2: `bg-zinc-400 text-black` (Silver)
   - 3: `bg-amber-600 text-black` (Bronze)
   - 4+: `bg-zinc-700 text-zinc-300`

3. **Table columns:**
   - Rank (medal badge)
   - Name (first_name, with initial avatar)
   - Username (with @ prefix if exists, or "-")
   - Wallet (truncated: first 6 + "..." + last 4 chars, or "Not connected")
   - Points (formatted with toLocaleString)

4. **Empty state:** "No data for this period" centered message

5. **Styling:** Dark theme matching existing dashboard components:
   - Rows: `bg-zinc-800/50 rounded-lg`
   - Text: `text-white` for main, `text-zinc-400` for secondary
   - Spacing: `space-y-2` for rows, `gap-3` for columns

CSV headers for export:
```typescript
const headers = [
  { label: 'Rank', key: 'rank' },
  { label: 'Name', key: 'first_name' },
  { label: 'Username', key: 'username' },
  { label: 'Wallet Address', key: 'wallet_address' },
  { label: 'Points', key: 'points' },
];
```

Prepare export data by mapping null wallet_address to "Not connected" before passing to ExportButton.
  </action>
  <verify>Component file exists with proper TypeScript types, exports LeaderboardTable function, imports ExportButton and uses it correctly.</verify>
  <done>LeaderboardTable component renders leaderboard data with medals, truncated wallets, and working CSV export.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate Leaderboards into Dashboard</name>
  <files>src/app/admin/dashboard/page.tsx</files>
  <action>
Add leaderboard section to the admin dashboard.

1. **Add TypeScript interfaces** at top of file:
```typescript
interface LeaderboardEntry {
  rank: number;
  first_name: string;
  username: string | null;
  wallet_address: string | null;
  points: number;
}

interface LeaderboardsData {
  overall: LeaderboardEntry[];
  weekly: LeaderboardEntry[];
  daily: LeaderboardEntry[];
  generated_at: string;
}
```

2. **Add state:**
```typescript
const [leaderboards, setLeaderboards] = useState<LeaderboardsData | null>(null);
```

3. **Update fetchData:** Add leaderboards API to Promise.all:
```typescript
const leaderboardsRes = await fetch('/api/admin/analytics/leaderboards');
// ... in await Promise.all for json parsing:
leaderboardsRes.ok ? leaderboardsRes.json() : null,
// ... after parsing:
setLeaderboards(leaderboardsData);
```

4. **Add import:**
```typescript
import { LeaderboardTable } from '@/components/admin/LeaderboardTable';
```

5. **Add section** after the "Leaderboard Dynamics" section (end of page):
```tsx
{/* Top 10 Leaderboards */}
<div className="mt-6">
  <h2 className="text-sm font-medium text-zinc-400 uppercase tracking-wider mb-4">
    Top 10 Leaderboards
  </h2>
  <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-4">
      <LeaderboardTable
        title="Overall"
        data={leaderboards?.overall || []}
        filename="leaderboard-overall"
      />
    </div>
    <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-4">
      <LeaderboardTable
        title="Weekly"
        data={leaderboards?.weekly || []}
        filename="leaderboard-weekly"
      />
    </div>
    <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-4">
      <LeaderboardTable
        title="Daily"
        data={leaderboards?.daily || []}
        filename="leaderboard-daily"
      />
    </div>
  </div>
</div>
```

6. **Update loading skeleton:** Add a skeleton section for the 3 leaderboard cards at the bottom of the loading state.
  </action>
  <verify>
1. `npm run build` succeeds without TypeScript errors
2. Dev server shows leaderboard section at bottom of admin dashboard
3. All 3 leaderboard cards render with correct data
4. CSV export works for each leaderboard
  </verify>
  <done>Dashboard displays 3 leaderboard cards (Overall, Weekly, Daily) in a responsive grid with working data and export.</done>
</task>

</tasks>

<verification>
1. API endpoint returns valid JSON with all 3 leaderboards
2. Each leaderboard shows up to 10 users with rank, name, username, wallet, points
3. Medals display correctly for top 3 ranks
4. Wallet addresses are truncated appropriately
5. CSV export downloads file with correct headers and data
6. Empty states handled gracefully (no crashes, shows message)
7. Auto-refresh picks up leaderboard data every 60 seconds
8. Mobile responsive (cards stack on small screens)
</verification>

<success_criteria>
- Admin dashboard has new "Top 10 Leaderboards" section
- Three leaderboard cards visible: Overall, Weekly, Daily
- Each card shows up to 10 users with all required fields
- Export button on each card generates valid CSV
- No TypeScript errors, build passes
- Matches existing dashboard visual style
</success_criteria>

<output>
After completion, create `.planning/phases/10-admin-leaderboard-view/10-01-SUMMARY.md`
</output>
