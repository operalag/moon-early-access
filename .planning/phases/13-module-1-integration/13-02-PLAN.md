---
phase: 13-module-1-integration
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/components/education/SlideEngine.tsx
  - src/components/education/slides/ActionSlide.tsx
  - src/components/education/ModuleCard.tsx
  - src/app/education/page.tsx
  - src/app/education/[moduleId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can view module list at /education with progress and badges"
    - "User can navigate to Module 1 and see SlideEngine"
    - "User's progress resumes from last slide_index on return"
    - "Wallet connect button opens TonConnect modal"
    - "On module completion, points are awarded and badge is shown"
    - "Completed module shows badge in module list"
  artifacts:
    - path: "src/app/education/page.tsx"
      provides: "Module list page"
      min_lines: 40
    - path: "src/app/education/[moduleId]/page.tsx"
      provides: "Individual module page with SlideEngine"
      min_lines: 60
    - path: "src/components/education/ModuleCard.tsx"
      provides: "Module card with progress/badge UI"
      min_lines: 30
    - path: "src/components/education/SlideEngine.tsx"
      provides: "initialSlideIndex prop for resume"
      contains: "initialSlideIndex"
    - path: "src/components/education/slides/ActionSlide.tsx"
      provides: "TonConnect integration"
      contains: "useTonConnectUI"
  key_links:
    - from: "src/app/education/[moduleId]/page.tsx"
      to: "/api/education/progress"
      via: "fetch for progress"
      pattern: "fetch.*api/education/progress"
    - from: "src/app/education/[moduleId]/page.tsx"
      to: "/api/education/complete"
      via: "fetch on completion"
      pattern: "fetch.*api/education/complete"
    - from: "src/components/education/slides/ActionSlide.tsx"
      to: "TonConnect modal"
      via: "useTonConnectUI().openModal()"
      pattern: "openModal"
---

<objective>
Build the education UI with module list, module page, and wallet connect integration.

Purpose: Complete the Module 1 user experience from discovery to completion
Output: /education route with ModuleListPage, /education/[moduleId] with SlideEngine, TonConnect wallet action
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-module-1-integration/13-RESEARCH.md

# Prior phase artifacts
@src/components/education/SlideEngine.tsx
@src/components/education/slides/ActionSlide.tsx
@src/data/education_modules.json
@src/lib/educationTypes.ts
@src/components/WalletGateModal.tsx

# Phase 13-01 creates these (referenced but not read)
# - /api/education/progress
# - /api/education/complete
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend SlideEngine and ActionSlide for resume and wallet connect</name>
  <files>
    src/components/education/SlideEngine.tsx
    src/components/education/slides/ActionSlide.tsx
  </files>
  <action>
1. Update src/components/education/SlideEngine.tsx:
   - Add `initialSlideIndex?: number` to SlideEngineProps interface
   - Initialize useState with: `useState(initialSlideIndex ?? 0)`
   - This allows resuming from a persisted slide position

2. Update src/components/education/slides/ActionSlide.tsx:
   - Import `useTonConnectUI` and `useTonAddress` from '@tonconnect/ui-react'
   - Add `onActionComplete?: () => void` to component props
   - Get wallet connection state: `const userFriendlyAddress = useTonAddress()`
   - Get modal control: `const [tonConnectUI] = useTonConnectUI()`
   - Add `isConnected = !!userFriendlyAddress`

   - Add useEffect to auto-advance when wallet connects:
     ```typescript
     const hasTriggeredComplete = useRef(false);
     useEffect(() => {
       if (slide.actionType === 'wallet_connect' && isConnected && !hasTriggeredComplete.current) {
         hasTriggeredComplete.current = true;
         onActionComplete?.();
       }
     }, [isConnected, slide.actionType, onActionComplete]);
     ```

   - Update button onClick handler:
     - If actionType is 'wallet_connect' and NOT connected: call `tonConnectUI.openModal()`
     - If connected: call `onActionComplete?.()`

   - Update button text: Show "Continue" if connected, otherwise show `slide.buttonText`

3. Update SlideEngine renderSlide to pass onActionComplete to ActionSlideComponent:
   - Add a new callback `handleActionComplete = () => { goNext(); }`
   - Pass it: `<ActionSlideComponent slide={slide} onActionComplete={handleActionComplete} />`
  </action>
  <verify>
    - TypeScript compiles: `npx tsc --noEmit`
    - SlideEngine has initialSlideIndex: `grep -q "initialSlideIndex" src/components/education/SlideEngine.tsx`
    - ActionSlide has TonConnect: `grep -q "useTonConnectUI" src/components/education/slides/ActionSlide.tsx`
    - ActionSlide has openModal: `grep -q "openModal" src/components/education/slides/ActionSlide.tsx`
  </verify>
  <done>
    - SlideEngine accepts initialSlideIndex prop for resume
    - ActionSlide opens TonConnect modal when actionType is 'wallet_connect'
    - ActionSlide auto-advances when wallet connection detected
    - Button shows "Continue" when already connected
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ModuleCard component and education pages</name>
  <files>
    src/components/education/ModuleCard.tsx
    src/app/education/page.tsx
    src/app/education/[moduleId]/page.tsx
  </files>
  <action>
1. Create src/components/education/ModuleCard.tsx:
   - Props: module (from JSON), progress (from API, can be null)
   - Display module.icon, module.title, module.description
   - Show progress states:
     - If progress?.badge_earned: Show amber badge pill with module.badgeName
     - If progress?.completed_at: Show green Check icon
     - If module.isLocked: Show Lock icon and gray out the card
     - Otherwise: Show ChevronRight icon
   - Use Link to `/education/${module.id}` (disabled if locked)
   - Styling: bg-white/5, border border-white/10, rounded-2xl, hover states
   - Import Check, Lock, ChevronRight from lucide-react

2. Create src/app/education/page.tsx (ModuleListPage):
   - 'use client' directive
   - Import education_modules.json as educationData
   - Import useTelegram hook to get user.id
   - Fetch all progress on mount: GET /api/education/progress?userId={user.id}
   - Store progress as Record<string, UserEducationProgress> keyed by module_id
   - Compute locked state dynamically:
     - Module is unlocked if: no prerequisiteModuleId OR prerequisite module has completed_at
   - Render page header: "Net Practice" title
   - Render ModuleCard for each module, passing computed isLocked and progress
   - Show loading state while fetching progress

3. Create src/app/education/[moduleId]/page.tsx (ModulePage):
   - 'use client' directive
   - useParams to get moduleId
   - Import education_modules.json and find module by id
   - Import useTelegram for user.id
   - Import useRouter for navigation

   State management:
   - initialSlideIndex: number (loaded from API)
   - isCompleted: boolean (loaded from API)
   - isLoading: boolean

   On mount:
   - Fetch progress: GET /api/education/progress?userId={user.id}&moduleId={moduleId}
   - Set initialSlideIndex from progress.slide_index (default 0)
   - Set isCompleted from progress.completed_at

   Handlers:
   - handleSlideChange(index: number): POST to /api/education/progress to persist
   - handleComplete():
     - POST to /api/education/complete with { userId, moduleId, pointsAmount: module.totalPoints, badgeId: module.badgeId }
     - Navigate to /education after completion

   Render:
   - If isLoading: Show loading spinner
   - If isCompleted: Show completion summary (badge earned, "Return to Modules" button)
   - Otherwise: Render SlideEngine with slides, initialSlideIndex, onSlideChange, onComplete

   Module not found: Show "Module not found" error
  </action>
  <verify>
    - TypeScript compiles: `npx tsc --noEmit`
    - All files exist:
      - `ls src/components/education/ModuleCard.tsx`
      - `ls src/app/education/page.tsx`
      - `ls "src/app/education/[moduleId]/page.tsx"`
    - ModuleCard uses Link: `grep -q "Link" src/components/education/ModuleCard.tsx`
    - Education page imports modules: `grep -q "education_modules" src/app/education/page.tsx`
    - Module page calls complete API: `grep -q "api/education/complete" "src/app/education/[moduleId]/page.tsx"`
  </verify>
  <done>
    - ModuleCard shows title, description, progress badge, lock state
    - /education shows all modules with progress and badges
    - /education/[moduleId] loads progress and renders SlideEngine
    - Progress persists on slide changes
    - Module completion awards points and navigates back to list
    - Completed modules show completion summary on revisit
  </done>
</task>

</tasks>

<verification>
Run these checks after all tasks:

```bash
# TypeScript compiles
npx tsc --noEmit

# All files exist
ls -la src/components/education/SlideEngine.tsx
ls -la src/components/education/slides/ActionSlide.tsx
ls -la src/components/education/ModuleCard.tsx
ls -la src/app/education/page.tsx
ls -la "src/app/education/[moduleId]/page.tsx"

# SlideEngine has initialSlideIndex prop
grep "initialSlideIndex" src/components/education/SlideEngine.tsx

# ActionSlide has TonConnect
grep "useTonConnectUI" src/components/education/slides/ActionSlide.tsx
grep "openModal" src/components/education/slides/ActionSlide.tsx

# Module page calls both APIs
grep "api/education/progress" "src/app/education/[moduleId]/page.tsx"
grep "api/education/complete" "src/app/education/[moduleId]/page.tsx"
```
</verification>

<success_criteria>
- SlideEngine supports initialSlideIndex for resume functionality
- ActionSlide triggers TonConnect modal for wallet_connect action
- ActionSlide auto-advances when wallet is connected
- ModuleCard displays module info with progress and badge states
- /education page shows all modules with earned badges visible
- /education/[moduleId] loads user progress and renders SlideEngine
- Progress is persisted on slide changes
- Module completion awards points and grants badge
- User returning to completed module sees summary (not re-runs module)
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-module-1-integration/13-02-SUMMARY.md`
</output>
