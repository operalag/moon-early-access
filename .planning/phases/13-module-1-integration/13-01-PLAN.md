---
phase: 13-module-1-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/pointsEngine.ts
  - src/app/api/education/progress/route.ts
  - src/app/api/education/complete/route.ts
autonomous: true

must_haves:
  truths:
    - "Progress API returns user's slide_index and completed_at for a given module"
    - "Progress API persists slide_index when called with POST"
    - "Complete API awards points via pointsEngine"
    - "Complete API sets badge_earned and completed_at in database"
    - "Double completion calls are idempotent (no duplicate points)"
  artifacts:
    - path: "src/lib/pointsEngine.ts"
      provides: "education_complete point reason"
      contains: "education_complete"
    - path: "src/app/api/education/progress/route.ts"
      provides: "GET/POST for progress CRUD"
      exports: ["GET", "POST"]
    - path: "src/app/api/education/complete/route.ts"
      provides: "Module completion with points and badge"
      exports: ["POST"]
  key_links:
    - from: "src/app/api/education/complete/route.ts"
      to: "src/lib/pointsEngine.ts"
      via: "awardPoints import"
      pattern: "awardPoints.*education_complete"
    - from: "src/app/api/education/progress/route.ts"
      to: "user_education_progress table"
      via: "supabaseAdmin"
      pattern: "supabaseAdmin.*user_education_progress"
---

<objective>
Create the backend API infrastructure for education module progress tracking and completion rewards.

Purpose: Enable progress persistence and points/badge awarding for Module 1 completion
Output: Two API routes (progress CRUD, completion) and extended PointReason type
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-module-1-integration/13-RESEARCH.md

# Prior phase artifacts
@src/lib/pointsEngine.ts
@src/lib/supabaseAdmin.ts
@src/lib/educationTypes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add education_complete to PointReason and create progress API</name>
  <files>
    src/lib/pointsEngine.ts
    src/app/api/education/progress/route.ts
  </files>
  <action>
1. In src/lib/pointsEngine.ts, add 'education_complete' to the PointReason union type after 'welcome_bonus'.

2. Create src/app/api/education/progress/route.ts with GET and POST handlers:

GET handler:
- Accept query params: userId (required), moduleId (optional)
- If moduleId provided: Query single progress record
- If moduleId omitted: Query all progress records for user (for module list)
- Use supabaseAdmin (service role required due to RLS)
- Return { progress: data } or { progress: null } if not found (PGRST116 is not-found, not an error)

POST handler:
- Accept body: { userId, moduleId, slideIndex }
- Use upsert with onConflict: 'user_id,module_id' to insert or update
- Only update slide_index and updated_at (do not touch completed_at or badge_earned)
- Return { progress: data }

Use NextResponse from next/server. Validate userId is present and numeric.
  </action>
  <verify>
    - TypeScript compiles: `npx tsc --noEmit`
    - PointReason includes 'education_complete': `grep -q "education_complete" src/lib/pointsEngine.ts`
    - Progress route exports GET and POST: `grep -E "export async function (GET|POST)" src/app/api/education/progress/route.ts`
  </verify>
  <done>
    - PointReason type includes 'education_complete'
    - GET /api/education/progress?userId=X returns progress or null
    - GET /api/education/progress?userId=X&moduleId=Y returns single module progress
    - POST /api/education/progress creates/updates slide_index
  </done>
</task>

<task type="auto">
  <name>Task 2: Create module completion API with points and badge</name>
  <files>
    src/app/api/education/complete/route.ts
  </files>
  <action>
Create src/app/api/education/complete/route.ts with POST handler:

1. Accept body: { userId, moduleId, pointsAmount, badgeId }

2. Check if already completed (idempotency):
   - Query user_education_progress for this user+module
   - If completed_at is already set, return { success: true, message: 'Already completed' }
   - Do NOT award points again

3. Mark module complete:
   - Upsert to user_education_progress with:
     - completed_at: new Date().toISOString()
     - badge_earned: true
     - updated_at: new Date().toISOString()
   - Use onConflict: 'user_id,module_id'

4. Award points (wrapped in try/catch):
   - Import awardPoints from @/lib/pointsEngine
   - Call awardPoints(userId, pointsAmount, 'education_complete', { module_id: moduleId, badge_id: badgeId })
   - If this fails, log error but don't fail the whole request (points are secondary to completion tracking)

5. Return { success: true, newPoints: result } where result is the return from awardPoints

Validate that userId and moduleId are present. Return 400 if missing.
  </action>
  <verify>
    - TypeScript compiles: `npx tsc --noEmit`
    - Complete route exports POST: `grep -q "export async function POST" src/app/api/education/complete/route.ts`
    - Route imports awardPoints: `grep -q "awardPoints" src/app/api/education/complete/route.ts`
    - Route checks completed_at before awarding: `grep -q "completed_at" src/app/api/education/complete/route.ts`
  </verify>
  <done>
    - POST /api/education/complete awards points and sets badge_earned=true
    - Calling twice for same user/module returns success but doesn't double-award
    - Points engine called with 'education_complete' reason
  </done>
</task>

</tasks>

<verification>
Run these checks after all tasks:

```bash
# TypeScript compiles
npx tsc --noEmit

# All files exist
ls -la src/lib/pointsEngine.ts
ls -la src/app/api/education/progress/route.ts
ls -la src/app/api/education/complete/route.ts

# education_complete in PointReason
grep "education_complete" src/lib/pointsEngine.ts

# Progress route has GET and POST
grep -E "export async function (GET|POST)" src/app/api/education/progress/route.ts

# Complete route has POST and uses awardPoints
grep "export async function POST" src/app/api/education/complete/route.ts
grep "awardPoints" src/app/api/education/complete/route.ts
```
</verification>

<success_criteria>
- PointReason type extended with 'education_complete'
- /api/education/progress GET returns user progress (single module or all)
- /api/education/progress POST upserts slide_index
- /api/education/complete POST awards points via pointsEngine
- /api/education/complete is idempotent (no double points)
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-module-1-integration/13-01-SUMMARY.md`
</output>
